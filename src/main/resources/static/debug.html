<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Authentication</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Authentication Debug Tool</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Login Test</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testLogin()">Test Login</button>
                        <div id="loginResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>API Test</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success" onclick="testUsersAPI()">Test Users API</button>
                        <div id="apiResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Local Storage</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-info" onclick="checkStorage()">Check Storage</button>
                        <button class="btn btn-warning" onclick="clearStorage()">Clear Storage</button>
                        <div id="storageResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Console Output</h5>
                    </div>
                    <div class="card-body">
                        <div id="consoleOutput" style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Override console.log to capture output
        const originalLog = console.log;
        const originalError = console.error;
        const consoleOutput = document.getElementById('consoleOutput');
        
        function addToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '[ERROR]' : '[LOG]';
            consoleOutput.textContent += `${timestamp} ${prefix} ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };

        async function testLogin() {
            const resultDiv = document.getElementById('loginResult');
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Testing login...';
            
            try {
                console.log('Testing login with admin credentials...');
                
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });
                
                console.log('Login response status:', response.status);
                
                const data = await response.json();
                console.log('Login response data:', data);
                
                if (response.ok) {
                    // Store the token
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('user', JSON.stringify({
                        username: data.username,
                        email: data.email,
                        role: data.role
                    }));
                    
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>Login Successful!</strong><br>
                            Token: ${data.token.substring(0, 50)}...<br>
                            Role: ${data.role}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Login Failed!</strong><br>
                            Status: ${response.status}<br>
                            Message: ${data.message || 'Unknown error'}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Login error:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Network Error!</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        async function testUsersAPI() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Testing Users API...';
            
            try {
                const token = localStorage.getItem('authToken');
                console.log('Testing Users API with token:', token ? token.substring(0, 50) + '...' : 'No token');
                
                if (!token) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>No Token!</strong><br>
                            Please login first.
                        </div>
                    `;
                    return;
                }
                
                const response = await fetch('/api/users', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Users API response status:', response.status);
                console.log('Users API response headers:', Object.fromEntries(response.headers.entries()));
                
                if (response.ok) {
                    const users = await response.json();
                    console.log('Users API response data:', users);
                    
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>API Success!</strong><br>
                            Found ${users.length} users<br>
                            Status: ${response.status}
                        </div>
                    `;
                } else {
                    const errorData = await response.text();
                    console.log('Users API error response:', errorData);
                    
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>API Failed!</strong><br>
                            Status: ${response.status}<br>
                            Response: ${errorData}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Users API error:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Network Error!</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        function checkStorage() {
            const resultDiv = document.getElementById('storageResult');
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');
            
            console.log('Checking local storage...');
            console.log('Token:', token ? token.substring(0, 50) + '...' : 'None');
            console.log('User:', user);
            
            resultDiv.innerHTML = `
                <div class="alert alert-info">
                    <strong>Local Storage Contents:</strong><br>
                    <strong>Token:</strong> ${token ? token.substring(0, 50) + '...' : 'None'}<br>
                    <strong>User:</strong> ${user || 'None'}
                </div>
            `;
        }

        function clearStorage() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            console.log('Local storage cleared');
            
            document.getElementById('storageResult').innerHTML = `
                <div class="alert alert-warning">
                    Local storage cleared!
                </div>
            `;
        }

        // Auto-check storage on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Debug page loaded');
            checkStorage();
        });
    </script>
</body>
</html>
